<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper
	namespace="com.xmsy.server.zxyy.manager.modules.manager.user.dao.UserDao">

	<!-- 可根据自己的需求，是否要使用 -->
	<resultMap
		type="com.xmsy.server.zxyy.manager.modules.manager.user.entity.UserEntity"
		id="userMap">
		<result property="id" column="id" />
		<result property="deleteStatus" column="delete_status" />
		<result property="createTime" column="create_time" />
		<result property="updateTime" column="update_time" />
		<result property="version" column="version" />
		<result property="account" column="account" />
		<result property="portrait" column="portrait" />
		<result property="sex" column="sex" />
		<result property="userType" column="user_type" />
		<result property="token" column="token" />
		<result property="unionType" column="union_type" />
		<result property="openId" column="open_id" />
		<result property="unionId" column="union_id" />
		<result property="superiorsId" column="superiors_id" />
		<result property="forbiddenEnable" column="forbidden_enable" />
		<result property="nobetEnable" column="nobet_enable" />
		<result property="abnormalEnable" column="abnormal_enable" />
		<result property="frozenEnable" column="frozen_enable" />
		<result property="pointKillEnable" column="point_kill_enable" />
		<result property="pointKillRate" column="point_kill_rate" />
		<result property="hierarchyId" column="hierarchy_id" />
		<result property="coin" column="coin" />
		<result property="commission" column="commission" />
		<result property="money" column="money" />
		<result property="registerIp" column="register_ip" />
		<result property="registerDeviceCode" column="register_device_code" />
		<result property="userName" column="user_name" />
		<result property="remark" column="remark" />
		<result property="agentEnable" column="agent_enable" />
		<result property="noScan" column="no_scan" />
	</resultMap>
	<!--统计查询-->
	<select id="count" resultType="Map">

		SELECT
		COUNT(*)sonPeopleCount,sum(room_card)roomCardCount,sum(coin*0.01)coinCount,sum(commission)commissionCount
		 from user where superiors_id = #{id}

	</select>
	<!-- 新增用户返回用户ID -->
	<insert id="insertGetId" keyProperty="id"
		useGeneratedKeys="true"
		parameterType="com.xmsy.server.zxyy.manager.modules.manager.user.entity.UserEntity">
		INSERT INTO user
		<!-- (`create_time`, `account`,`user_name`,`portrait`,`sex`, `user_type`,
			`register_ip`, `register_device_code`,`union_type`, `open_id`,`union_id`,
			`superiors_id`,`agent_enable`,`coin`, `hierarchy_id`) VALUES (#{createTime},
			#{account}, #{userName}, #{portrait},#{sex}, #{userType}, #{registerIp},
			#{registerDeviceCode}, #{unionType}, #{openId},#{unionId}, #{superiorsId},#{agentEnable},1000000000,
			#{hierarchyId}) -->
		<trim prefix="(" suffix=")" suffixOverrides=",">
			create_time,
			<if test="updateTime != null">
				update_time,
			</if>
			<if test="account != null">
				account,
			</if>
			<if test="userName != null">
				user_name,
			</if>
			<if test="portrait != null">
				portrait,
			</if>
			<if test="sex != null">
				sex,
			</if>
			<if test="userType != null">
				user_type,
			</if>
			<if test="registerIp != null">
				register_ip,
			</if>
			<if test="registerDeviceCode != null">
				register_device_code,
			</if>
			<if test="unionType != null">
				union_type,
			</if>
			<if test="openId != null">
				open_id,
			</if>
			<if test="unionId != null">
				union_id,
			</if>
			<if test="superiorsId != null">
				superiors_id,
			</if>
			<if test="agentEnable != null">
				agent_enable,
			</if>
			<if test="hierarchyId != null">
				hierarchy_id,
			</if>
			<if test="coin != null">
				coin,
			</if>
		</trim>
		<trim prefix="values (" suffix=")" suffixOverrides=",">
			#{createTime},
			<if test="updateTime != null">
				#{updateTime},
			</if>
			<if test="account != null">
				#{account},
			</if>
			<if test="userName != null">
				#{userName},
			</if>
			<if test="portrait != null">
				#{portrait},
			</if>
			<if test="sex != null">
				#{sex},
			</if>
			<if test="userType != null">
				#{userType},
			</if>
			<if test="registerIp != null">
				#{registerIp},
			</if>
			<if test="registerDeviceCode != null">
				#{registerDeviceCode},
			</if>
			<if test="unionType != null">
				#{unionType},
			</if>
			<if test="openId != null">
				#{openId},
			</if>
			<if test="unionId != null">
				#{unionId},
			</if>
			<if test="superiorsId != null">
				#{superiorsId},
			</if>
			<if test="agentEnable != null">
				#{agentEnable},
			</if>
			<if test="hierarchyId != null">
				#{hierarchyId},
			</if>
			<if test="coin != null">
				#{coin},
			</if>
		</trim>
	</insert>

	<!-- 根据账号查询 -->
	<select id="queryByAccount" resultType="com.xmsy.server.zxyy.manager.modules.manager.user.param.UserParamTwo">
		SELECT
		a.id id,
		a.account,
		a.user_name userName,
		a.create_time createTime,
		a.money,
		a.coin,
		e.bank_card bankCard,
		a.room_card roomCard
		FROM
		`user` a
		LEFT JOIN user_info e ON e.user_id = a.id
		where a.delete_status=0
		AND a.account=#{account}
	</select>

	<!-- 根据层级列表查询用户集合 -->
	<select id="findUserListByHierarchy" resultMap="userMap">
		select * from user
		where delete_status=0
		and hierarchy_id in
		<foreach collection="hierarchyIDs" item="item" open="("
			separator="," close=")">
			#{item}
		</foreach>
	</select>

	<!-- 根据账号列表查询用户集合 -->
	<select id="findUserListByAccount" resultMap="userMap">
		select * from user
		where delete_status=0
		and account in
		<foreach collection="accountList" item="item" open="("
			separator="," close=")">
			#{item}
		</foreach>
	</select>

	<!-- 根据userId列表查询用户集合 -->
	<select id="findUserListByIdList" resultMap="userMap">
		select * from user
		where delete_status=0
		and id in
		<foreach collection="idList" item="item" open="("
			separator="," close=")">
			#{item}
		</foreach>
	</select>

	<!-- 会员管理页面分页查询 -->
	<select id="findUserPage" resultType="Map">
		SELECT
		false showEdit,
		false showBtn,
		a.id id,
		a.hierarchy_id hierarchyId,
		a.risk_hierarchy_id riskHierarchyId,
		a.account,
		a.commission as commission,
		a.game_info_id as gameInfoId,
		IF(a.game_info_id = 0, 0, 1) AS game_info,
		a.user_name userName,
		a.user_type userType,
		a.superiors_id superiorsId,
		a.token,a.remark,a.remark oldRemark,
		a.register_ip registerIp,
		a.register_ip_address registerIpAddress,
		a.forbidden_enable
		forbiddenEnable,
		a.create_time createTime,
		a.nobet_enable nobetEnable,
		a.abnormal_enable abnormalEnable,
		a.frozen_enable frozenEnable,
		a.no_scan noScan,
		a.game_server_id gameServerId,
		a.money,
		a.coin,
		a.room_card roomCard,
		a.vip_id vipId,
		a.phone,
		a.freeze_coin freezeCoin,
		a.channel_code channelCode
		FROM
		`user` a
		where a.delete_status=0
		<if test="user.account !=null and user.account!=''">
			AND a.account=#{user.account}
		</if>
		<if test="user.id !=null">
			AND a.id=#{user.id}
		</if>
		<if test="user.superiorsId !=null and user.superiorsId >0">
			AND a.superiors_id=#{user.superiorsId}
		</if>
		<if
			test="user.superiorsAccount !=null and user.superiorsAccount!=''">
			AND a.superiors_id in (select id from `user` where
			account=#{user.superiorsAccount})
		</if>
		<if test="user.userName !=null and user.userName !=''">
			AND a.user_name=#{user.userName}
		</if>
		<if test="user.bankCard !=null and user.bankCard!=''">
			AND a.id in (SELECT user_id from user_info e WHERE
			e.bank_card=#{user.bankCard})
		</if>
		<if test="user.deviceType !=null and user.deviceType!=''">
			AND a.id in (SELECT user_id from user_login e WHERE
			e.device_type=#{user.deviceType})
		</if>
		<if test="user.deviceCode !=null and user.deviceCode!=''">
			AND a.id in (SELECT user_id from user_login e WHERE
			e.device_code=#{user.deviceCode})
		</if>

		<if test="user.hierarchyId !=null ">
			AND a.hierarchy_id=#{user.hierarchyId}
		</if>
		<if test="user.registerIp !=null and user.registerIp !=''">
			AND a.register_ip=#{user.registerIp}
		</if>
<!-- 		<if test="user.loginIp !=null and user.loginIp !=''"> -->
<!-- 			AND b.ip=#{user.loginIp} -->
<!-- 		</if> -->
<!-- 		<if test="user.deviceCode !=null and user.deviceCode!=''"> -->
<!-- 			AND b.device_code=#{user.deviceCode} -->
<!-- 		</if> -->
<!-- 		<if test="user.deviceType !=null and user.deviceType!=''"> -->
<!-- 			AND b.device_type=#{user.deviceType} -->
<!-- 		</if> -->
		<if test="user.userType !=null and user.userType!=''">
			AND a.user_type=#{user.userType}
		</if>
		<if test="user.trial ==1">
			AND a.user_type = 'TRIAL'
		</if>
		<if test="user.trial ==0">
			AND a.user_type != 'TRIAL'
		</if>
		<if test="user.forbiddenEnable !=null ">
			AND a.forbidden_enable=#{user.forbiddenEnable}
		</if>
		<if test="user.nobetEnable !=null ">
			AND a.nobet_enable=#{user.nobetEnable}
		</if>
		<if test="user.abnormalEnable !=null ">
			AND a.abnormal_enable=#{user.abnormalEnable}
		</if>
		<if test="user.frozenEnable !=null ">
			AND a.frozen_enable=#{user.frozenEnable}
		</if>
		<if test="user.startTime !=null and user.startTime!='' ">
			AND a.create_time &gt;=#{user.startTime}
		</if>
		<if test="user.endTime !=null and user.endTime!='' ">
			AND a.create_time &lt;=#{user.endTime}
		</if>
		<if test="user.sortOption !=null  and user.sortOption !=''">
			ORDER BY ${user.sortOption} ${user.orientation}
		</if>
		<if test="user.sortOption ==null or user.sortOption ==''">
			ORDER BY CONCAT(game_info, a.id) DESC
		</if>

	</select>
	<!-- 单个会员分析管理页面分页查询 -->
	<select id="findSingleUserPage" resultType="com.xmsy.server.zxyy.manager.modules.manager.user.param.UserParamThree">
		SELECT
		a.id id,
		c.`name` hierarchyName,
		a.account,
		a.user_name userName,
		a.user_type userType,
		a.forbidden_enable
		forbiddenEnable,
		a.create_time createTime,
		a.nobet_enable nobetEnable,
		a.abnormal_enable abnormalEnable,
		a.frozen_enable frozenEnable,
		b.create_time loginTime,
		b.last_login_time
		lastLoginTime,
		b.ip LoginIp,
		b.last_ip
		lastLoginIp,
		a.money,
		o.user_need_bet userNeedBet,
    	o.user_valid_bet userValidBet
		FROM
		`user` a
		LEFT JOIN user_login b ON a.id =
		b.user_id
		AND
		a.token = b.token
		AND login_status = "success"
		LEFT JOIN user_hierarchy
		c ON a.hierarchy_id = c.id and c.hierarchy_type=0
		LEFT JOIN order_cash_examine
		o ON a.account = o.user_account
		where a.delete_status=0
		<if test="user.account !=null and user.account!=''">
			AND a.account=#{user.account}
		</if>
		ORDER BY o.create_time desc LIMIT 1
	</select>

	<!-- 登录日志 -->
	<select id="logonLog" resultType="com.xmsy.server.zxyy.manager.modules.manager.userlogin.entity.UserLoginEntity">
		SELECT
		a.account,
		b.token,
		b.create_time lastLoginTime,
		b.ip lastIp,
		b.device_code deviceCode,
		b.device_type
		deviceType,
		b.region,
		b.domain,
		b.edition,
		b.browser,
		b.nation,
	    b.login_status loginStatus,
		b.ip_address ipAddress
		FROM
		`user` a
		LEFT JOIN user_login b ON a.id =
		b.user_id
		where a.delete_status=0
		<if test="user.account !=null and user.account!=''">
			AND a.account=#{user.account}
		</if>
		<if test="user.startTime !=null and user.startTime!='' ">
			AND b.create_time &gt;=#{user.startTime}
		</if>
		<if test="user.endTime !=null and user.endTime!='' ">
			AND b.create_time &lt;=#{user.endTime}
		</if>
	</select>
	<!-- 会员管理页面分页查询 -->
	<select id="findUserPageForRecharge" resultType="Map">

	SELECT
	*
	FROM
		(SELECT
		false showEdit,
		false showBtn,
		a.id id,
		max(h.id) AS rechargeId,
		a.hierarchy_id hierarchyId,
		a.risk_hierarchy_id riskHierarchyId,
		a.account,
		a.commission as commission,
		a.game_info_id as gameInfoId,
		IF(a.game_info_id = 0, 0, 1) AS game_info,
		a.user_name userName,
		a.user_type userType,
		a.superiors_id superiorsId,
		a.token,a.remark,a.remark oldRemark,
		a.register_ip registerIp,
		a.register_ip_address registerIpAddress,
		a.forbidden_enable forbiddenEnable,
		a.create_time createTime,
		a.nobet_enable nobetEnable,
		a.abnormal_enable abnormalEnable,
		a.frozen_enable frozenEnable,
		a.no_scan noScan,
		a.game_server_id gameServerId,
		a.money,
		a.coin,
		a.room_card roomCard,
		a.vip_id vipId,
		a.phone,
		a.channel_code channelCode
		FROM
		`user` a
		LEFT JOIN order_recharge h ON a.id = h.user_id and h.status=2
		where a.delete_status=0
		<if test="user.account !=null and user.account!=''">
			AND a.account=#{user.account}
		</if>
		<if test="user.id !=null">
			AND a.id=#{user.id}
		</if>
		<if test="user.superiorsId !=null and user.superiorsId >0">
			AND a.superiors_id=#{user.superiorsId}
		</if>
		<if test="user.superiorsAccount !=null and user.superiorsAccount!=''">
			AND a.superiors_id in (select id from `user` where account=#{user.superiorsAccount})
		</if>
		<if test="user.userName !=null and user.userName !=''">
			AND a.user_name=#{user.userName}
		</if>
		<if test="user.bankCard !=null and user.bankCard!=''">
			AND a.id in (SELECT user_id from user_info e WHERE
			e.bank_card=#{user.bankCard})
		</if>
		<if test="user.hierarchyId !=null ">
			AND a.hierarchy_id=#{user.hierarchyId}
		</if>
		<if test="user.registerIp !=null and user.registerIp !=''">
			AND a.register_ip=#{user.registerIp}
		</if>
<!-- 		<if test="user.loginIp !=null and user.loginIp !=''"> -->
<!-- 			AND b.ip=#{user.loginIp} -->
<!-- 		</if> -->
<!-- 		<if test="user.deviceCode !=null and user.deviceCode!=''"> -->
<!-- 			AND b.device_code=#{user.deviceCode} -->
<!-- 		</if> -->
<!-- 		<if test="user.deviceType !=null and user.deviceType!=''"> -->
<!-- 			AND b.device_type=#{user.deviceType} -->
<!-- 		</if> -->
		<if test="user.userType !=null and user.userType!=''">
			AND a.user_type=#{user.userType}
		</if>
		<if test="user.trial ==1">
			AND a.user_type = 'TRIAL'
		</if>
		<if test="user.trial ==0">
			AND a.user_type != 'TRIAL'
		</if>
		<if test="user.forbiddenEnable !=null ">
			AND a.forbidden_enable=#{user.forbiddenEnable}
		</if>
		<if test="user.nobetEnable !=null ">
			AND a.nobet_enable=#{user.nobetEnable}
		</if>
		<if test="user.abnormalEnable !=null ">
			AND a.abnormal_enable=#{user.abnormalEnable}
		</if>
		<if test="user.frozenEnable !=null ">
			AND a.frozen_enable=#{user.frozenEnable}
		</if>
		<if test="user.startTime !=null and user.startTime!='' ">
			AND a.create_time &gt;=#{user.startTime}
		</if>
		<if test="user.endTime !=null and user.endTime!='' ">
			AND a.create_time &lt;=#{user.endTime}
		</if>
		<!-- <if test="user.sortOption !=null  and user.sortOption !=''">
		    ORDER BY ${user.sortOption} ${user.orientation}
		</if>
		<if test="user.sortOption ==null or user.sortOption ==''">
		    ORDER BY CONCAT(game_info, a.id) DESC
		</if> -->
		GROUP BY
			a.id
		) f
		ORDER BY
	f.rechargeId DESC
	</select>
	<!-- 会员管理页面分页查询取款总额排序 -->
	<select id="findUserPageForRechargeNumOrder" resultType="Map">

	SELECT
	*
	FROM
		(SELECT
		false showEdit,
		false showBtn,
		a.id id,
		sum(h.amount) AS rechargeAmount,
		a.hierarchy_id hierarchyId,
		a.risk_hierarchy_id riskHierarchyId,
		a.account,
		a.commission as commission,
		a.game_info_id as gameInfoId,
		IF(a.game_info_id = 0, 0, 1) AS game_info,
		a.user_name userName,
		a.user_type userType,
		a.superiors_id superiorsId,
		a.token,a.remark,a.remark oldRemark,
		a.register_ip registerIp,
		a.register_ip_address registerIpAddress,
		a.forbidden_enable forbiddenEnable,
		a.create_time createTime,
		a.nobet_enable nobetEnable,
		a.abnormal_enable abnormalEnable,
		a.frozen_enable frozenEnable,
		a.no_scan noScan,
		a.game_server_id gameServerId,
		a.money,
		a.coin,
		a.room_card roomCard,
		a.vip_id vipId,
		a.phone,
		a.channel_code channelCode
		FROM
		`user` a
		LEFT JOIN order_recharge h ON a.id = h.user_id and h.status=2
		where a.delete_status=0
		<if test="user.account !=null and user.account!=''">
			AND a.account=#{user.account}
		</if>
		<if test="user.id !=null">
			AND a.id=#{user.id}
		</if>
		<if test="user.superiorsId !=null and user.superiorsId >0">
			AND a.superiors_id=#{user.superiorsId}
		</if>
		<if test="user.superiorsAccount !=null and user.superiorsAccount!=''">
			AND a.superiors_id in (select id from `user` where account=#{user.superiorsAccount})
		</if>
		<if test="user.userName !=null and user.userName !=''">
			AND a.user_name=#{user.userName}
		</if>
		<if test="user.bankCard !=null and user.bankCard!=''">
			AND a.id in (SELECT user_id from user_info e WHERE
			e.bank_card=#{user.bankCard})
		</if>
		<if test="user.hierarchyId !=null ">
			AND a.hierarchy_id=#{user.hierarchyId}
		</if>
		<if test="user.registerIp !=null and user.registerIp !=''">
			AND a.register_ip=#{user.registerIp}
		</if>
<!-- 		<if test="user.loginIp !=null and user.loginIp !=''"> -->
<!-- 			AND b.ip=#{user.loginIp} -->
<!-- 		</if> -->
<!-- 		<if test="user.deviceCode !=null and user.deviceCode!=''"> -->
<!-- 			AND b.device_code=#{user.deviceCode} -->
<!-- 		</if> -->
<!-- 		<if test="user.deviceType !=null and user.deviceType!=''"> -->
<!-- 			AND b.device_type=#{user.deviceType} -->
<!-- 		</if> -->
		<if test="user.userType !=null and user.userType!=''">
			AND a.user_type=#{user.userType}
		</if>
		<if test="user.trial ==1">
			AND a.user_type = 'TRIAL'
		</if>
		<if test="user.trial ==0">
			AND a.user_type != 'TRIAL'
		</if>
		<if test="user.forbiddenEnable !=null ">
			AND a.forbidden_enable=#{user.forbiddenEnable}
		</if>
		<if test="user.nobetEnable !=null ">
			AND a.nobet_enable=#{user.nobetEnable}
		</if>
		<if test="user.abnormalEnable !=null ">
			AND a.abnormal_enable=#{user.abnormalEnable}
		</if>
		<if test="user.frozenEnable !=null ">
			AND a.frozen_enable=#{user.frozenEnable}
		</if>
		<if test="user.startTime !=null and user.startTime!='' ">
			AND a.create_time &gt;=#{user.startTime}
		</if>
		<if test="user.endTime !=null and user.endTime!='' ">
			AND a.create_time &lt;=#{user.endTime}
		</if>
		GROUP BY
			a.id
		) f
		ORDER BY
	f.rechargeAmount DESC
	</select>
	<!-- 会员管理页面分页查询 -->
	<select id="findUserPageForTakeMoney" resultType="Map">

	SELECT
	*
	FROM
		(SELECT
		false showEdit,
		false showBtn,
		a.id id,
		max(h.id) AS takeId,
		a.hierarchy_id hierarchyId,
		a.risk_hierarchy_id riskHierarchyId,
		a.account,
		a.commission as commission,
		a.game_info_id as gameInfoId,
		IF(a.game_info_id = 0, 0, 1) AS game_info,
		a.user_name userName,
		a.user_type userType,
		a.superiors_id superiorsId,
		a.token,a.remark,a.remark oldRemark,
		a.register_ip registerIp,
		a.register_ip_address registerIpAddress,
		a.forbidden_enable forbiddenEnable,
		a.create_time createTime,
		a.nobet_enable nobetEnable,
		a.abnormal_enable abnormalEnable,
		a.frozen_enable frozenEnable,
		a.no_scan noScan,
		a.game_server_id gameServerId,
		a.money,
		a.coin,
		a.room_card roomCard,
		a.vip_id vipId,
		a.phone,
		a.channel_code channelCode
		FROM
		`user` a
		LEFT JOIN order_take_money h ON a.id = h.user_id and h.status=2
		where a.delete_status=0
		<if test="user.account !=null and user.account!=''">
			AND a.account=#{user.account}
		</if>
		<if test="user.id !=null">
			AND a.id=#{user.id}
		</if>
		<if test="user.superiorsId !=null and user.superiorsId >0">
			AND a.superiors_id=#{user.superiorsId}
		</if>
		<if test="user.superiorsAccount !=null and user.superiorsAccount!=''">
			AND a.superiors_id in (select id from `user` where account=#{user.superiorsAccount})
		</if>
		<if test="user.userName !=null and user.userName !=''">
			AND a.user_name=#{user.userName}
		</if>
		<if test="user.bankCard !=null and user.bankCard!=''">
			AND a.id in (SELECT user_id from user_info e WHERE
			e.bank_card=#{user.bankCard})
		</if>
		<if test="user.hierarchyId !=null ">
			AND a.hierarchy_id=#{user.hierarchyId}
		</if>
		<if test="user.registerIp !=null and user.registerIp !=''">
			AND a.register_ip=#{user.registerIp}
		</if>
<!-- 		<if test="user.loginIp !=null and user.loginIp !=''"> -->
<!-- 			AND b.ip=#{user.loginIp} -->
<!-- 		</if> -->
<!-- 		<if test="user.deviceCode !=null and user.deviceCode!=''"> -->
<!-- 			AND b.device_code=#{user.deviceCode} -->
<!-- 		</if> -->
<!-- 		<if test="user.deviceType !=null and user.deviceType!=''"> -->
<!-- 			AND b.device_type=#{user.deviceType} -->
<!-- 		</if> -->
		<if test="user.userType !=null and user.userType!=''">
			AND a.user_type=#{user.userType}
		</if>
		<if test="user.trial ==1">
			AND a.user_type = 'TRIAL'
		</if>
		<if test="user.trial ==0">
			AND a.user_type != 'TRIAL'
		</if>
		<if test="user.forbiddenEnable !=null ">
			AND a.forbidden_enable=#{user.forbiddenEnable}
		</if>
		<if test="user.nobetEnable !=null ">
			AND a.nobet_enable=#{user.nobetEnable}
		</if>
		<if test="user.abnormalEnable !=null ">
			AND a.abnormal_enable=#{user.abnormalEnable}
		</if>
		<if test="user.frozenEnable !=null ">
			AND a.frozen_enable=#{user.frozenEnable}
		</if>
		<if test="user.startTime !=null and user.startTime!='' ">
			AND a.create_time &gt;=#{user.startTime}
		</if>
		<if test="user.endTime !=null and user.endTime!='' ">
			AND a.create_time &lt;=#{user.endTime}
		</if>
		GROUP BY
			a.id
		) f
		ORDER BY
	f.takeId DESC

	</select>
	<!-- 会员管理页面分页查询 -->
	<select id="findUserPageForTakeMoneyOrderNum" resultType="Map">
	SELECT
	*
	FROM
		(SELECT
		false showEdit,
		false showBtn,
		a.id id,
		sum(h.take_amount) AS takeAmount,
		a.hierarchy_id hierarchyId,
		a.risk_hierarchy_id riskHierarchyId,
		a.account,
		a.commission as commission,
		a.game_info_id as gameInfoId,
		IF(a.game_info_id = 0, 0, 1) AS game_info,
		a.user_name userName,
		a.user_type userType,
		a.superiors_id superiorsId,
		a.token,a.remark,a.remark oldRemark,
		a.register_ip registerIp,
		a.register_ip_address registerIpAddress,
		a.forbidden_enable forbiddenEnable,
		a.create_time createTime,
		a.nobet_enable nobetEnable,
		a.abnormal_enable abnormalEnable,
		a.frozen_enable frozenEnable,
		a.no_scan noScan,
		a.game_server_id gameServerId,
		a.money,
		a.coin,
		a.room_card roomCard,
		a.vip_id vipId,
		a.phone,
		a.channel_code channelCode
		FROM
		`user` a
		LEFT JOIN order_take_money h ON a.id = h.user_id and h.status=2
		where a.delete_status=0
		<if test="user.account !=null and user.account!=''">
			AND a.account=#{user.account}
		</if>
		<if test="user.id !=null">
			AND a.id=#{user.id}
		</if>
		<if test="user.superiorsId !=null and user.superiorsId >0">
			AND a.superiors_id=#{user.superiorsId}
		</if>
		<if test="user.superiorsAccount !=null and user.superiorsAccount!=''">
			AND a.superiors_id in (select id from `user` where account=#{user.superiorsAccount})
		</if>
		<if test="user.userName !=null and user.userName !=''">
			AND a.user_name=#{user.userName}
		</if>
		<if test="user.bankCard !=null and user.bankCard!=''">
			AND a.id in (SELECT user_id from user_info e WHERE
			e.bank_card=#{user.bankCard})
		</if>
		<if test="user.hierarchyId !=null ">
			AND a.hierarchy_id=#{user.hierarchyId}
		</if>
		<if test="user.registerIp !=null and user.registerIp !=''">
			AND a.register_ip=#{user.registerIp}
		</if>
<!-- 		<if test="user.loginIp !=null and user.loginIp !=''"> -->
<!-- 			AND b.ip=#{user.loginIp} -->
<!-- 		</if> -->
<!-- 		<if test="user.deviceCode !=null and user.deviceCode!=''"> -->
<!-- 			AND b.device_code=#{user.deviceCode} -->
<!-- 		</if> -->
<!-- 		<if test="user.deviceType !=null and user.deviceType!=''"> -->
<!-- 			AND b.device_type=#{user.deviceType} -->
<!-- 		</if> -->
		<if test="user.userType !=null and user.userType!=''">
			AND a.user_type=#{user.userType}
		</if>
		<if test="user.trial ==1">
			AND a.user_type = 'TRIAL'
		</if>
		<if test="user.trial ==0">
			AND a.user_type != 'TRIAL'
		</if>
		<if test="user.forbiddenEnable !=null ">
			AND a.forbidden_enable=#{user.forbiddenEnable}
		</if>
		<if test="user.nobetEnable !=null ">
			AND a.nobet_enable=#{user.nobetEnable}
		</if>
		<if test="user.abnormalEnable !=null ">
			AND a.abnormal_enable=#{user.abnormalEnable}
		</if>
		<if test="user.frozenEnable !=null ">
			AND a.frozen_enable=#{user.frozenEnable}
		</if>
		<if test="user.startTime !=null and user.startTime!='' ">
			AND a.create_time &gt;=#{user.startTime}
		</if>
		<if test="user.endTime !=null and user.endTime!='' ">
			AND a.create_time &lt;=#{user.endTime}
		</if>
		GROUP BY
			a.id
		) f
		ORDER BY
	f.takeAmount DESC
	</select>
	<!-- 会员管理页面分页查询 -->
	<select id="findRiskUserPage" resultType="Map">
		SELECT
		a.id id,
		c.`name` hierarchyName,
		a.account,
		IF(a.game_info_id = 0,
		0, 1) AS game_info,
		a.user_name userName,
		a.user_type userType,
		a.superiors_id superiorsId,
		a.token,a.remark,a.remark oldRemark,
		a.register_ip registerIp,
		a.register_ip_address registerIpAddress,
		a.forbidden_enable forbiddenEnable,
		a.create_time createTime,
		a.nobet_enable nobetEnable,
		a.abnormal_enable abnormalEnable,
		a.frozen_enable frozenEnable,
		a.game_server_id gameServerId,
		a.game_info_id gameInfoId,
		a.money,
		a.no_scan noScan,
		a.coin
		FROM
		`user` a
		LEFT JOIN
		user_hierarchy c ON a.risk_hierarchy_id = c.id
		where
		a.delete_status=0 and a.risk_hierarchy_id>0
		<if test="user.account !=null and user.account!=''">
			AND a.account=#{user.account}
		</if>
		<if test="user.id !=null">
			AND a.id=#{user.id}
		</if>
		<if test="user.superiorsId !=null and user.superiorsId >0">
			AND a.superiors_id=#{user.superiorsId}
		</if>
		<if
			test="user.superiorsAccount !=null and user.superiorsAccount!=''">
			AND a.superiors_id in (select id from `user` where
			account=#{user.superiorsAccount})
		</if>
		<if test="user.userName !=null and user.userName !=''">
			AND a.user_name=#{user.userName}
		</if>
		<if test="user.hierarchyId !=null ">
			AND a.hierarchy_id=#{user.hierarchyId}
		</if>
		<if test="user.riskHierarchyId !=null ">
			AND a.risk_hierarchy_id=#{user.riskHierarchyId}
		</if>
		<if test="user.registerIp !=null and user.registerIp !=''">
			AND a.register_ip=#{user.registerIp}
		</if>
		<if test="user.userType !=null and user.userType!=''">
			AND a.user_type=#{user.userType}
		</if>
		<if test="user.trial ==1">
			AND a.user_type = 'TRIAL'
		</if>
		<if test="user.trial ==0">
			AND a.user_type != 'TRIAL'
		</if>
		<if test="user.forbiddenEnable !=null ">
			AND a.forbidden_enable=#{user.forbiddenEnable}
		</if>
		<if test="user.nobetEnable !=null ">
			AND a.nobet_enable=#{user.nobetEnable}
		</if>
		<if test="user.abnormalEnable !=null ">
			AND a.abnormal_enable=#{user.abnormalEnable}
		</if>
		<if test="user.frozenEnable !=null ">
			AND a.frozen_enable=#{user.frozenEnable}
		</if>
		<if test="user.startTime !=null and user.startTime!='' ">
			AND a.create_time &gt;=#{user.startTime}
		</if>
		<if test="user.endTime !=null and user.endTime!='' ">
			AND a.create_time &lt;=#{user.endTime}
		</if>
		<if test="user.sortOption !=null  and user.sortOption !=''">
			ORDER BY ${user.sortOption} ${user.orientation}
		</if>
		<if test="user.sortOption ==null or user.sortOption ==''">
			ORDER BY CONCAT(risk_hierarchy_id, a.id) DESC
		</if>

	</select>
	<!-- 会员管理页面 -->
	<select id="findUserList" resultType="Map">
		SELECT
		a.id id,
		a.hierarchy_id hierarchyId,
		a.risk_hierarchy_id riskHierarchyId,
		a.vip_id vipId,
		c.`name` hierarchyName,
		a.account,
		a.user_name userName,
		a.user_type userType,
		a.superiors_id
		superiorsId,
		a.token,a.remark,a.remark oldRemark,
		a.register_ip
		registerIp,
		a.forbidden_enable forbiddenEnable,
		a.nobet_enable
		nobetEnable,
		a.abnormal_enable abnormalEnable,
		a.frozen_enable frozenEnable,
		b.create_time loginTime,
		b.ip
		LoginIp,
		b.device_code deviceCode,
		b.device_type deviceType,
		b.region,
		b.nation,
		b.ip_address address,
		b.domain,
		b.edition,
		b.browser,
		a.money,
		a.phone,
		a.coin,
		a.freeze_coin freezeCoin,
		a.channel_code channelCode
		FROM
		`user` a
		LEFT JOIN user_login b ON a.id =
		b.user_id
		AND a.token = b.token
		AND
		login_status = "success"
		LEFT JOIN
		user_hierarchy c ON a.hierarchy_id
		=
		c.id
		where a.delete_status=0
		<if test="user.account !=null and user.account!=''">
			AND a.account=#{user.account}
		</if>
		<if test="user.id !=null">
			AND a.id=#{user.id}
		</if>
		<if test="user.superiorsId !=null and user.superiorsId >0">
			AND a.superiors_id=#{user.superiorsId}
		</if>
		<if
			test="user.superiorsAccount !=null and user.superiorsAccount!=''">
			AND a.superiors_id in (select id from `user` where
			account=#{user.superiorsAccount})
		</if>
		<if test="user.userName !=null and user.userName !=''">
			AND a.user_name=#{user.userName}
		</if>
		<if test="user.bankCard !=null and user.bankCard!=''">
			AND a.id in (SELECT user_id from user_info e WHERE
			e.bank_card=#{user.bankCard})
		</if>
		<if test="user.hierarchyId !=null ">
			AND a.hierarchy_id=#{user.hierarchyId}
		</if>
		<if test="user.registerIp !=null and user.registerIp !=''">
			AND a.register_ip=#{user.registerIp}
		</if>
		<if test="user.loginIp !=null and user.loginIp !=''">
			AND b.ip=#{user.loginIp}
		</if>
		<if test="user.deviceCode !=null and user.deviceCode!=''">
			AND b.device_code=#{user.deviceCode}
		</if>
		<if test="user.deviceType !=null and user.deviceType!=''">
			AND b.device_type=#{user.deviceType}
		</if>
		<if test="user.userType !=null and user.userType!=''">
			AND a.user_type=#{user.userType}
		</if>
		<if test="user.trial ==1">
			AND a.user_type = 'TRIAL'
		</if>
		<if test="user.trial ==0">
			AND a.user_type != 'TRIAL'
		</if>
		<if test="user.forbiddenEnable !=null ">
			AND a.forbidden_enable=#{user.forbiddenEnable}
		</if>
		<if test="user.nobetEnable !=null ">
			AND a.nobet_enable=#{user.nobetEnable}
		</if>
		<if test="user.abnormalEnable !=null ">
			AND a.abnormal_enable=#{user.abnormalEnable}
		</if>
		<if test="user.frozenEnable !=null ">
			AND a.frozen_enable=#{user.frozenEnable}
		</if>
		<if test="user.startTime !=null and user.startTime !=''">
			AND a.create_time &gt;=#{user.startTime}
		</if>
		<if test="user.endTime !=null  and user.endTime !=''">
			AND a.create_time &lt;=#{user.endTime}
		</if>
	</select>

	<!-- 会员管理页面 -->
	<select id="findUserListForCsv" resultType="Map">
		SELECT
		a.id id,
		a.account,
		a.hierarchy_id hierarchyId,
		a.vip_id vipId,
		a.risk_hierarchy_id riskHierarchyId,
		a.user_name userName,
		a.user_type userType,
		a.superiors_id superiorsId,
		a.token,a.remark,
		a.register_ip registerIp,
		a.forbidden_enable forbiddenEnable,
		a.nobet_enable nobetEnable,
		a.abnormal_enable abnormalEnable,
		a.frozen_enable frozenEnable,
		a.money,
		a.phone ,
		a.room_card roomCard,
		a.commission ,
		a.coin,
		sum(b.money) yybMoney,
		sum(b.unprofit_money) unyybMoney,
		a.create_time createTime,
		ore.amount rechargeAmount,
		ore.discount_amount discountAmount,
		otm.take_amount takeAmount
		FROM `user` a
		LEFT JOIN user_balance b ON a.id=b.user_id
		LEFT JOIN (select user_id,sum(amount) amount,sum(discount_amount) discount_amount
					FROM order_recharge WHERE status=2 GROUP BY user_id )  ore on a.id=ore.user_id
		LEFT JOIN (select user_id ,sum(take_amount) take_amount
					FROM order_take_money WHERE status=2 GROUP BY user_id) otm on a.id=otm.user_id
		where a.delete_status=0
		<if test="user.account !=null and user.account!=''">
			AND a.account=#{user.account}
		</if>
		<if test="user.id !=null">
			AND a.id=#{user.id}
		</if>
		<if test="user.superiorsId !=null and user.superiorsId >0">
			AND a.superiors_id=#{user.superiorsId}
		</if>
		<if
			test="user.superiorsAccount !=null and user.superiorsAccount!=''">
			AND a.superiors_id in (select id from `user` where
			account=#{user.superiorsAccount})
		</if>
		<if test="user.userName !=null and user.userName !=''">
			AND a.user_name=#{user.userName}
		</if>
		<if test="user.bankCard !=null and user.bankCard!=''">
			AND a.id in (SELECT user_id from user_info e WHERE
			e.bank_card=#{user.bankCard})
		</if>
		<if test="user.hierarchyId !=null ">
			AND a.hierarchy_id=#{user.hierarchyId}
		</if>
		<if test="user.registerIp !=null and user.registerIp !=''">
			AND a.register_ip=#{user.registerIp}
		</if>
<!-- 		<if test="user.loginIp !=null and user.loginIp !=''"> -->
<!-- 			AND b.ip=#{user.loginIp} -->
<!-- 		</if> -->
<!-- 		<if test="user.deviceCode !=null and user.deviceCode!=''"> -->
<!-- 			AND b.device_code=#{user.deviceCode} -->
<!-- 		</if> -->
<!-- 		<if test="user.deviceType !=null and user.deviceType!=''"> -->
<!-- 			AND b.device_type=#{user.deviceType} -->
<!-- 		</if> -->
		<if test="user.userType !=null and user.userType!=''">
			AND a.user_type=#{user.userType}
		</if>
		<if test="user.trial ==1">
			AND a.user_type = 'TRIAL'
		</if>
		<if test="user.trial ==0">
			AND a.user_type != 'TRIAL'
		</if>
		<if test="user.forbiddenEnable !=null ">
			AND a.forbidden_enable=#{user.forbiddenEnable}
		</if>
		<if test="user.nobetEnable !=null ">
			AND a.nobet_enable=#{user.nobetEnable}
		</if>
		<if test="user.abnormalEnable !=null ">
			AND a.abnormal_enable=#{user.abnormalEnable}
		</if>
		<if test="user.frozenEnable !=null ">
			AND a.frozen_enable=#{user.frozenEnable}
		</if>
		<if test="user.startTime !=null and user.startTime !=''">
			AND a.create_time &gt;=#{user.startTime}
		</if>
		<if test="user.endTime !=null  and user.endTime !=''">
			AND a.create_time &lt;=#{user.endTime}
		</if>
		GROUP BY a.id 
	</select>

	<!-- 用户密码信息 -->
	<select id="getUserPasswordInfo"
		resultType="com.xmsy.server.zxyy.manager.modules.web.user.result.UserPasswordResult">
		SELECT
		u.id,
		u.money,
		u.coin,
		up.bank_password as bankPassword
		FROM
		user u
		LEFT JOIN user_password up ON u.id = up.user_id
		AND up.delete_status = FALSE
		WHERE
		u.delete_status = FALSE
		AND u.id = #{id}
	</select>
	<!-- 代理列表 -->
	<select id="getAgentList"
		resultType="com.xmsy.server.zxyy.manager.modules.manager.agent.param.Agent">
		SELECT
		u.id,
		u.account,
		u.coin,
		u.commission,
		u.money,
		ur.num,
		ur.amount as
		agentCommission,
		ur.coin as agentCoin,
		r.name as agentHierarchyName,
		ur.recommendation_code AS recommendationCode,
		IFNULL(sum(g.bet_coins),0) as validBet,
		ur.team_enable as teamEnable
		FROM
		user u
		LEFT JOIN
		user_recommendation ur ON u.id = ur.user_id
		LEFT JOIN
		user_recommendation_tree urr ON u.id = urr.parant_user_id and urr.user_parant_distance>0
		LEFT JOIN
		user_bet_record g ON urr.user_id = g.user_id
		LEFT JOIN
		user_agent_hierarchy r ON ur.agent_hierarchy_id = r.id
		WHERE
		u.agent_enable = true
		AND ur.num > 0
		AND u.delete_status = false
		AND
		ur.delete_status = false
		<if test="user.account !=null and user.account!=''">
			AND u.account=#{user.account}
		</if>
		GROUP BY u.id
	</select>
	<!-- 团队代理列表 -->
	<select id="getAgentTeamList"
		resultType="com.xmsy.server.zxyy.manager.modules.manager.agent.param.TeamAgent">
		SELECT
			a.user_id AS id,
			a.user_account AS account,
			a.recommendation_code AS recommendationCode,
			a.num AS directNum,
			a.amount AS agentCommission,
			a.coin AS agentCoin,
			a.team_enable AS teamEnable,
			b. NAME AS agentHierarchyName,
			c. NAME AS recommendationHierarchyName,
			IFNULL(sum(e.bet_coins), 0) AS sumValidBet,
			IFNULL(
				sum(
					CASE
					WHEN d.id IS NULL THEN
						0
					ELSE
						1
					END
				),
				0
			) AS sumNum,
			IFNULL(
				sum(
					CASE
					WHEN d.user_parant_distance = 1 THEN
						e.bet_coins
					ELSE
						0
					END
				),
				0
			) AS directValidBet
		FROM
			user_recommendation a
		LEFT JOIN user_agent_hierarchy b ON a.agent_hierarchy_id = b.id
		LEFT JOIN user_recommendation_grade c ON a.recommendation_hierarchy_id = c.id
		LEFT JOIN user_recommendation_tree d ON d.parant_user_id = a.user_id
		AND d.user_parant_distance > 0
		LEFT JOIN user_bet_record e ON d.user_id = e.user_id
		WHERE
			a.num > 0
		AND a.team_enable = 1
		AND
		a.delete_status = false
		<if test="user.account !=null and user.account!=''">
			AND a.user_account=#{user.account}
		</if>
		GROUP BY
			a.user_id
		ORDER BY
			sumValidBet DESC
	</select>

	<!-- 代理下线列表 -->
	<select id="getAgentSubordinateList"
		resultType="com.xmsy.server.zxyy.manager.modules.manager.agent.param.Subordinate">

		SELECT
			s.user_id as id,
			s.user_account as account,
			IFNULL(SUM(r.bet_coins), 0) AS validBet
		FROM
			(
				SELECT
					b.id AS user_id,b.account AS user_account
				FROM
					user_recommendation_tree a
				LEFT JOIN user b ON a.user_id=b.id
				WHERE
					a.parant_user_id = #{userId}
				AND a.user_parant_distance = 1
				<if test="account !=null and account!=''">
					AND b.account=#{account}
				</if>
			) s
		LEFT JOIN user_recommendation_tree t ON s.user_id = t.parant_user_id
		LEFT JOIN user_bet_record r ON r.user_id = t.user_id

		GROUP BY s.user_id
	</select>

	<!-- 会员管理页面计算有多少条 -->
	<select id="queryTotal" resultType="Integer">
		select count(1) FROM `user` a
		LEFT JOIN user_login b ON a.id =
		b.user_id
		AND a.token = b.token
		AND login_status = "success"
		LEFT JOIN
		user_hierarchy c ON a.hierarchy_id = c.id
		where a.delete_status=0
		<if test="account !=null and account!=''">
			AND a.account=#{account}
		</if>
		<if test="user.id !=null">
			AND a.id=#{user.id}
		</if>
		<if test="superiorsId !=null and superiorsId>0">
			AND a.superiors_id=#{superiorsId}
		</if>
		<if test="superiorsAccount !=null and superiorsAccount!=''">
			AND a.superiors_id in (select id from `user` where
			account=#{superiorsAccount})
		</if>
		<if test="userName !=null and userName !=''">
			AND a.user_name=#{userName}
		</if>
		<if test="bankCard !=null and bankCard!=''">
			AND a.id in (SELECT user_id from user_info WHERE
			bank_card=#{bankCard})
		</if>
		<if test="hierarchyId !=null ">
			AND a.hierarchy_id=#{hierarchyId}
		</if>
		<if test="registerIp !=null and registerIp !=''">
			AND a.register_ip=#{registerIp}
		</if>
		<if test="loginIp !=null and loginIp !=''">
			AND b.ip=#{loginIp}
		</if>
		<if test="deviceCode !=null and deviceCode!=''">
			AND b.device_code=#{deviceCode}
		</if>
		<if test="deviceType !=null and deviceType!=''">
			AND b.device_type=#{deviceType}
		</if>
		<if test="userType !=null and userType!=''">
			AND a.user_type=#{userType}
		</if>
		<if test="trial ==1">
			AND a.user_type = 'TRIAL'
		</if>
		<if test="trial ==0">
			AND a.user_type != 'TRIAL'
		</if>
		<if test="forbiddenEnable !=null and forbiddenEnable!=''">
			AND a.forbidden_enable=#{forbiddenEnable}
		</if>
		<if test="nobetEnable !=null and nobetEnable!=''">
			AND a.nobet_enable=#{nobetEnable}
		</if>
		<if test="abnormalEnable !=null and abnormalEnable!=''">
			AND a.abnormal_enable=#{abnormalEnable}
		</if>
		<if test="frozenEnable !=null and frozenEnable!=''">
			AND a.frozen_enable=#{frozenEnable}
		</if>
		<if test="startTime !=null and startTime !=''">
			AND a.create_time &gt;=#{startTime}
		</if>
		<if test="endTime !=null and endTime !=''">
			AND a.create_time &lt;=#{endTime}
		</if>
	</select>

	<!-- 删除会员的银行卡信息 -->
	<update id="deleteBankInfo">
		update user_info set
		bank_name='',bank_address='',bank_card='',bank_account_name=''
		where
		user_id=#{userId}
	</update>

	<!-- 修改用户是否首冲 -->
	<update id="updateUserFirstRecharge">
		update user set first_recharge=true,
		update_time=now()
		where id=#{id}
	</update>

	<!-- 修改备注 -->
	<update id="updateUserBaseInfo">
		update user set
		<if test="remark !=null ">
			remark =#{remark},
		</if>
		update_time =now()
		where id=#{id}
	</update>

	<!-- 根据用户ID修改金额 -->
	<update id="updateUserWalletByUserId">
		update user set
		<if test="coin != null">
			coin =coin+#{coin},
		</if>
		<if test="commission != null">
			commission =commission+#{commission},
		</if>
		<if test="money != null">
			money =money+#{money},
		</if>
		<if test="roomCard != null">
			room_card =room_card+#{roomCard},
		</if>
		update_time=now()
		where id=#{id}
		<if test="coin != null">
			and coin+#{coin} &gt;= 0
		</if>
		<if test="commission != null">
			and commission+#{commission} &gt;= 0
		</if>
		<if test="money != null">
			and money+#{money} &gt;= 0
		</if>
		<if test="roomCard != null">
			and room_card+#{roomCard} &gt;= 0
		</if>
	</update>

	<!-- 试玩账号列表 包含删除 -->
	<select id="getTrialUserList" resultMap="userMap">
		SELECT * from `user`
		where user_type='TRIAL'
		ORDER BY delete_status,account
	</select>

	<!-- 根据账号查询用户的数量 -->
	<select id="countUserByAccount" resultType="Integer">
		SELECT count(1) from
		`user`
		where account=#{account}
	</select>
	<!-- 修改删除状态为0 -->
	<update id="updateUserDeleteStatus">
		UPDATE `user` SET
		delete_status=0,money=0,coin=0
		where
		id=#{id}
	</update>

	<!-- 统计会员数量，有效会员数量(有充值)====非试玩账号 -->
	<select id="getStatisticsNumber" resultType="Map">
		SELECT
		COUNT(*) AS
		userNumber,
		(
		SELECT
		COUNT(*)
		FROM
		`user` a
		LEFT JOIN order_recharge b ON
		a.id = b.user_id
		WHERE
		b.fristrecharge = 1
		AND a.user_type != 'TRIAL'
		AND
		a.delete_status = 0
		) AS validUserNumber
		FROM
		`user` a
		WHERE
		a.user_type !=
		'TRIAL'
		AND a.delete_status = 0
	</select>

	<!-- 获取前7天及当前的新增会员数====非试玩账号 -->
	<select id="getInsertUserNumber" resultType="Map">
		SELECT
		COUNT(*) AS
		numbers,
		date_format(a.create_time, '%Y-%m-%d') as time
		FROM
		user a
		WHERE
		DATE_SUB(CURDATE(), INTERVAL 7 DAY) &lt;= date(a.create_time)
		and
		a.user_type != 'TRIAL'
		and a.delete_status=0
		GROUP BY
		date_format(a.create_time, '%Y-%m-%d')
	</select>
	<!-- 根据时间获取新增会员数 -->
	<select id="sumUserForDate" resultType="Map">
		SELECT
		IFNULL(COUNT(*), 0) AS userNumber,
		IFNULL((
		SELECT
		COUNT(*)
		FROM
		`user` a
		LEFT JOIN order_recharge b ON a.id = b.user_id
		WHERE
		b.fristrecharge = 1
		AND a.user_type = 'USER'
		AND a.delete_status = 0
		<if test="startDate !=null and startDate !=''">
			and date_format(a.create_time, '%Y-%m-%d')
			&gt;=#{startDate}
		</if>
		<if test="endDate !=null and endDate !=''">
			and date_format(a.create_time, '%Y-%m-%d') &lt;=#{endDate}
		</if>
		), 0) AS validUserNumber
		FROM
		user a
		WHERE
		a.user_type != 'TRIAL'
		and
		a.delete_status=0
		<if test="startDate !=null and startDate !=''">
			and date_format(a.create_time, '%Y-%m-%d')
			&gt;=#{startDate}
		</if>
		<if test="endDate !=null and endDate !=''">
			and date_format(a.create_time, '%Y-%m-%d') &lt;=#{endDate}
		</if>
	</select>

	<!-- 按照日期范围统计充值的金额 -->
	<select id="statisticsWealthByDay"
		resultType="com.xmsy.server.zxyy.manager.modules.manager.rankinglistday.entity.RankingListDayEntity">
		SELECT id userId,account userAccount,money amount FROM
		`user`
		WHERE user_type !='TRIAL'
		order by amount DESC;
	</select>

	<delete id="deleteUserById">
		delete from `user` where id=#{id}
	</delete>

	<!-- 统计被风控的账号 -->
	<select id="statisticsRiskNum"
		resultType="Map">
		SELECT a.*,b.`name` as riskName from (
			SELECT risk_hierarchy_id as riskHierarchyId,COUNT(id) as count from `user`
			WHERE risk_hierarchy_id>0
			GROUP BY risk_hierarchy_id) a
		LEFT JOIN user_hierarchy b on a.riskHierarchyId=b.id;
	</select>
	<!-- 获取用户风控人数总计 -->
	<select id="statisticsRiskTotalNum"
		resultType="Long">
		SELECT COUNT(id) as count from `user`
		WHERE risk_hierarchy_id>0
	</select>
	<!-- 通过UserEntity,以及代理商id    查询当前代理商下的所有会员信息 -->
	<select id="findProxyUser" resultMap="userMap">
		select u.id,u.account,u.user_name,u.coin,u.room_card,a.proxy_id as proxyId  from user u
		inner JOIN  user_info_increase a on a.user_id=u.id
		where u.delete_status=0
		<if test="user.proxyId != null and user.proxyId!=''">
		 	AND a.proxy_id=#{user.proxyId}
		</if>
		<if test="user.account !=null and user.account!=''">
			AND u.account=#{user.account}
		</if>
		<if test="user.userName !=null and user.userName !=''">
			AND u.user_name=#{user.userName}
		</if>
	</select>
	<update id="setReamrkNull">
		update user set remark=null where id=#{id}
	</update>
	<update id="setPhoneNull">
		update user set phone=null where id=#{id}
	</update>
	<select id="selectAccountById" resultType="String">
		SELECT account
		from `user`
		where delete_status=0 and id=#{id}
	</select>

	<!-- 修改会员层级通过id -->
	<update id="batchUpdateHierarchy">
		update `user` set hierarchy_id=#{hierarchyId} where id=#{id}
	</update>

	<!-- 修改会员类型通过Id -->
	<update id="batchMarkTestUser">
		update `user` set user_type="TEST" where id=#{id}
	</update>
	<!--  Gm账号id列表 -->
	<select id="getGmUser" resultType="Long">
		select id from user where user_type = 'TEST'
	</select>
	<select id="checkGmUser" resultType="Integer">
		select count(id) from user where user_type = 'TEST' and id=#{userId}
	</select>

	<select id="getSuperiorsName" resultType="String">
		SELECT account
		from  user
		WHERE delete_status=0 and id =
		(SELECT superiors_id
		from user WHERE id=#{userId}
	)
	</select>
</mapper>
